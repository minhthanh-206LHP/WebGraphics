<!DOCTYPE html>
<html lang="en">
 <head>
    <meta charset="utf-8">
    <title>Sobel Edge</title>

		<style>
			.color-cell {
				color: white;
			}
		</style>
  </head>
  <body>

	<table>
		<thead>
			<tr>
				<th>Source</th>
				<th>New</th>

			</tr>
		</thead>
		<tbody>
			<tr>
				<td>
					<video id = 'v' controls loop>
						<source  src ='./WhenIrishPeopleCantSpeakIrish.mp4' type="video/mp4">
					</video>
				</td>
				<td align="center" class="color-cell" id="hovered-color">
					<canvas id ='videoCanvas' width="64000" height="36000"></canvas>
				</td>
			</tr>
		</tbody>
	</table>

	
	
	<script>
		document.addEventListener('DOMContentLoaded',
		function(){
			var v = document.getElementById('v');
			var canvas = document.getElementById('videoCanvas');
			var context = canvas.getContext('2d');
			var back = document.createElement('canvas');
			var backcontext = back.getContext('2d');

			var cw = Math.floor(canvas.clientWidth / 100);
			var ch = Math.floor(canvas.clientHeight / 100);
			canvas.width = cw;
			canvas.height = ch;

			v.addEventListener('play',function(){
				cw = v.clientWidth;
				ch = v.clientHeight;
				canvas.width = cw;
				canvas.height = ch;
				back. width = cw;
				back.height = ch;
				draw(v,context,backcontext,cw,ch);
			},false);
		},false);

		function draw(v,c,bc,w,h) {
			if (v.paused || v.ended) return false;
			bc.drawImage(v,0,0,w,h);
			var idata = bc.getImageData(0,0,w,h);
			// var data = idata.data;
			var sobelData = Sobel(idata);
			var sobelImageData = sobelData.toImageData();
			// for (var i = 0; i < data.length; i += 4) {
			// 	var lightness = (3*data[i] + 4*data[i+1] + data[i+2])>>>3;
			// 	data[i] = lightness;
			// 	data[i+1] = lightness;
			// 	data[i+2] = lightness;
			// }
			// idata.data = data;
			// c.putImageData(idata,0,0);
			c.putImageData(sobelImageData,0,0);
			
			setTimeout(function() {draw(v,c,bc,w,h);}, 0);
		}

		// function sobel(img){
		// 	var Sctx = document.getElementById('videocanvas').getContext('2d');
		// 	var NeoCtx = document.getElementById('canvas').getContext('2d');
		// 	var imageData = Sctx.getImageData(0,0,img.width,img.height);
		// 	var sobelData = Sobel(imageData);
		// 	var sobelImageData = sobelData.toImageData();
		// 	NeoCtx.putImageData(sobelImageData,0,0);
		// }

		function Sobel(imageData) {
    if (!(this instanceof Sobel)) {
      return new Sobel(imageData);
    }

    var width = imageData.width;
    var height = imageData.height;

    var kernelX = [
      [-1,0,1],
      [-2,0,2],
      [-1,0,1]
    ];

    var kernelY = [
      [-1,-2,-1],
      [0,0,0],
      [1,2,1]
    ];

    var sobelData = [];
    var grayscaleData = [];

    function bindPixelAt(data) {
      return function(x, y, i) {
        i = i || 0;
        return data[((width * y) + x) * 4 + i];
      };
    }

    var data = imageData.data;
    var pixelAt = bindPixelAt(data);
    var x, y;

    for (y = 0; y < height; y++) {
      for (x = 0; x < width; x++) {
        var r = pixelAt(x, y, 0);
        var g = pixelAt(x, y, 1);
        var b = pixelAt(x, y, 2);

        var avg = (r + g + b) / 3;
        grayscaleData.push(avg, avg, avg, 255);
      }
    }

    pixelAt = bindPixelAt(grayscaleData);

    for (y = 0; y < height; y++) {
      for (x = 0; x < width; x++) {
        var pixelX = (
            (kernelX[0][0] * pixelAt(x - 1, y - 1)) +
            (kernelX[0][1] * pixelAt(x, y - 1)) +
            (kernelX[0][2] * pixelAt(x + 1, y - 1)) +
            (kernelX[1][0] * pixelAt(x - 1, y)) +
            (kernelX[1][1] * pixelAt(x, y)) +
            (kernelX[1][2] * pixelAt(x + 1, y)) +
            (kernelX[2][0] * pixelAt(x - 1, y + 1)) +
            (kernelX[2][1] * pixelAt(x, y + 1)) +
            (kernelX[2][2] * pixelAt(x + 1, y + 1))
        );

        var pixelY = (
          (kernelY[0][0] * pixelAt(x - 1, y - 1)) +
          (kernelY[0][1] * pixelAt(x, y - 1)) +
          (kernelY[0][2] * pixelAt(x + 1, y - 1)) +
          (kernelY[1][0] * pixelAt(x - 1, y)) +
          (kernelY[1][1] * pixelAt(x, y)) +
          (kernelY[1][2] * pixelAt(x + 1, y)) +
          (kernelY[2][0] * pixelAt(x - 1, y + 1)) +
          (kernelY[2][1] * pixelAt(x, y + 1)) +
          (kernelY[2][2] * pixelAt(x + 1, y + 1))
        );

        var magnitude = Math.sqrt((pixelX * pixelX) + (pixelY * pixelY))>>>0;

        sobelData.push(magnitude, magnitude, magnitude, 255);
      }
    }

    var clampedArray = sobelData;

    if (typeof Uint8ClampedArray === 'function') {
      clampedArray = new Uint8ClampedArray(sobelData);
    }

    clampedArray.toImageData = function() {
      return Sobel.toImageData(clampedArray, width, height);
    };

    return clampedArray;
  }

  Sobel.toImageData = function toImageData(data, width, height) {
    if (typeof ImageData === 'function' && Object.prototype.toString.call(data) === '[object Uint16Array]') {
      return new ImageData(data, width, height);
    } else {
      if (typeof window === 'object' && typeof window.document === 'object') {
        var canvas = document.createElement('canvas');

        if (typeof canvas.getContext === 'function') {
          var context = canvas.getContext('2d');
          var imageData = context.createImageData(width, height);
          imageData.data.set(data);
          return imageData;
        } else {
          return new FakeImageData(data, width, height);
        }
      } else {
        return new FakeImageData(data, width, height);
      }
    }
  };

  function FakeImageData(data, width, height) {
    return {
      width: width,
      height: height,
      data: data
    };
  }

  if (typeof exports !== 'undefined') {
    if (typeof module !== 'undefined' && module.exports) {
      exports = module.exports = Sobel;
    }
    exports.Sobel = Sobel;
  } else if (typeof define === 'function' && define.amd) {
    define([], function() {
      return Sobel;
    });
  } else {
    root.Sobel = Sobel;
  }

	</script>
	<script src="scripts.js"></script>
  </body>
</html>
